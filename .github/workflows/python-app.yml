name: Auto Merge to Staging

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.13"]
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run tests
        run: |
          pytest test_calculator.py -v --cov=calculator --cov-report=term-missing

  auto-merge-to-staging:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Merge to staging branch
        run: |
          BRANCH="${{ github.ref_name }}"
          
          # Create staging branch if it doesn't exist
          if ! git ls-remote --heads origin staging; then
            git checkout -b staging
            git push origin staging
          fi
          
          # Fetch and merge
          git fetch origin staging
          git checkout staging
          git merge --no-ff origin/$BRANCH -m "Auto-merge: $BRANCH â†’ staging

          âœ… Tests passed
          ðŸ¤– Automated by GitHub Actions"
          
          git push origin staging
          
          echo "âœ… Merged $BRANCH to staging!"
